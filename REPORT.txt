Scio.ly Next.js + Postgres (Drizzle) Performance Review

Scope
- App router Next.js site with Postgres via Drizzle and Cockroach-compatible driver; Supabase for user-centric tables.
- Review focused on real bottlenecks, not micro-optimizations.

Top Risks / Actionable Fixes (prioritized)
1) JSONB subtopic filters lack GIN index
   - Where: src/app/api/questions/route.ts builds conditions using subtopics @> [value] (OR chain).
   - Impact: Without a GIN index, queries that filter by subtopics will degrade to sequential scans as data grows.
   - Fix: Add a GIN index for jsonb containment. Example migration:
     CREATE INDEX IF NOT EXISTS questions_subtopics_gin ON questions USING GIN (subtopics jsonb_path_ops);
     or: CREATE INDEX IF NOT EXISTS questions_subtopics_gin ON questions USING GIN (subtopics);
   - Also consider consolidating multiple OR conditions by passing an array of subtopics and using a single @> containment where feasible.

2) Tournament ILIKE "%...%" is non-sargable
   - Where: addTournamentFilter uses ILIKE with both-sided wildcard.
   - Impact: Full scans on large tables; cannot leverage btree indexes.
   - Fix options:
     - If partial/contains match is required, add pg_trgm and a trigram index:
       CREATE EXTENSION IF NOT EXISTS pg_trgm;
       CREATE INDEX IF NOT EXISTS questions_tournament_trgm ON questions USING gin (tournament gin_trgm_ops);
     - If only prefix match is acceptable, switch to tournament ILIKE value% and add a normal btree index.

3) Unlimited practice fetch size (1000 questions) is heavy
   - Where: src/app/unlimited/Content.tsx fetches up to 1000 questions and stores them in localStorage.
   - Impact: Large network payloads, higher DB load, memory pressure on client; potential time-to-interaction delays on slower devices.
   - Fix:
     - Start with a smaller batch (e.g., 200–300) and lazy-load in chunks as the session progresses.
     - Or add a server endpoint to stream/paginate random questions using the existing random_f approach.

4) Dashboard/Supabase queries fetch entire history without bounds
   - Where: src/app/dashboard/Content.tsx and DashboardMain.tsx query user_stats with .order('date') and no limit/range; repeated on auth changes.
   - Impact: As user history grows, payloads increase and client work scales linearly; redundant reads on auth events.
   - Fix:
     - Limit to a time window (e.g., last 90 days) or use .lte/.gte with a server-computed range; add .limit.
     - Memoize/collapse duplicate loads; avoid refetching the full series on every auth change.

5) Images rendered with <img> without lazy loading
   - Where: unlimited/Content.tsx and test/components/QuestionCard.tsx render raw <img> tags.
   - Impact: Misses Next/Image optimizations (format/size), might eager-load, and can cause layout shifts.
   - Fix (minimal): add loading="lazy" and decoding="async", plus explicit dimensions or CSS aspect-ratio to stabilize layout. If remote hosts are known, prefer Next/Image and whitelist them in next.config.

6) Difficulty comparisons passed as strings
   - Where: questions GET route casts difficulty to string for comparisons.
   - Impact: Implicit casts can hinder planner optimizations; while minor now, it’s easy to clean up.
   - Fix: Pass typed numeric values to Drizzle comparators instead of stringifying.

7) RANDOM() sort fallback is expensive
   - Where: questions and quotes use ORDER BY RANDOM() as a fallback path in error cases.
   - Impact: Full-table random sort is O(n log n). It’s only a fallback, but ensure migration completes so fallback is rare.
   - Fix: Keep existing two-phase random_f seek and ensure indices/migrations are applied everywhere.

Database Layer Observations
- Good
  - Two-phase indexed-random selection on random_f with composite indexes for (event, random_f) and (division, random_f) reduces random selection cost.
  - Drizzle over postgres-js with prepared statements and pooling (max=20, idle/connection timeouts) is sensible for Cockroach/Postgres.
  - Limits enforced in APIs (default 50, max 200) protect against unbounded scans.
- Risks / Improvements
  - Add GIN on subtopics jsonb.
  - Consider composite index (event, division, random_f) if the common filter is both event and division together; validate with EXPLAIN before adding.
  - If difficulty is frequently filtered, a partial index (e.g., by event with difficulty) could help, but only if real-world queries need it.
  - Trigram index on tournament if substring search is a key UX feature.

API Routes
- Questions GET uses a solid builder pattern and two-phase random seek. Keep it.
- Questions batch uses parameterized SQL with array_position to preserve order. Safe and efficient for modest ID lists.
- Codebusters share route reads a single row by code + expiry; efficient and bounded.

Client/Rendering
- Unlimited mode large prefetch: consider chunked loading as above.
- Test page server fetch uses cache: 'no-store', appropriate for per-user personalization.
- Dashboard does additional localStorage scans; mostly negligible but can be guarded (quick bail-out if keys do not match expected prefix).
- Several components import Next/Image; good. For raw <img> cases, add lazy loading and explicit sizing.

Caching and ISR
- Docs routes use revalidate = 600 (10 min). Good balance for mostly static content.
- Dashboard/test declare force-dynamic, which is correct given user/session dependence.

What’s Working Well
- Indexed random selection (random_f) avoids expensive ORDER BY RANDOM() in hot paths.
- Sensible per-request limits; maximums prevent accidental large scans.
- Connection pooling with prepared statements and timeouts tuned; SSL pinned CA handling is robust.
- Server/client Supabase split is correct; SSR user retrieval via cookies is in place.
- Unlimited practice strips imageData before localStorage to avoid quota bloat.
- API request/response logging exists to measure latency and success rates.
- Docs ISR provides fast global delivery while allowing periodic content refresh.

Quick Wins (low effort)
- Add GIN index on subtopics.
- Add loading="lazy" decoding="async" and dimensions for <img> tags in Unlimited/Test UIs.
- Reduce Unlimited initial batch size; load more on demand.
- Add a time window + limit to user_stats queries and avoid duplicate fetch on auth state changes.
- Pass numeric types (not strings) to difficulty comparators.

Follow-up (measure first)
- Evaluate need for trigram index on tournament based on query frequency.
- Consider composite (event, division, random_f) only if it materially improves plans used in production.
- Track API latency p95/p99 and DB query plans using EXPLAIN ANALYZE in staging to validate changes.

Appendix: Relevant Files/Patterns
- DB schema: src/lib/db/schema.ts
- DB client: src/lib/db/index.ts
- Questions API: src/app/api/questions/route.ts
- Unlimited fetching: src/app/unlimited/Content.tsx
- Test SSR fetch: src/app/test/page.tsx
- Dashboard data loads: src/app/dashboard/Content.tsx, src/app/dashboard/components/DashboardMain.tsx
- Migrations (random_f + indexes): migrations/add_random_f_indexes.sql
